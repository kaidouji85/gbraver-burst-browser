#!/bin/sh

# CloudFormationの出力から環境変数を読み込む
# 本スクリプトとCodeBuildで同じ環境変数が定義されている場合、後者を優先する

if [ -z "${STACK_NAME}" ]; then
  echo "required environment variables not specified."
  return 1
fi

STACK_FILE=".tmp-api-stack"

aws cloudformation describe-stacks --stack-name "${STACK_NAME}" > "${STACK_FILE}"

if [ -z "${REST_API_URL}" ]; then
  REST_API_URL=`jq -r '.Stacks[] | .Outputs[] | select(.OutputKey == "HttpApiUrl") | .OutputValue' "${STACK_FILE}"`
fi

if [ -z "${WEBSOCKET_API_URL}" ]; then
  WEBSOCKET_API_URL=`jq -r '.Stacks[] | .Outputs[] | select(.OutputKey == "ServiceEndpointWebsocket") | .OutputValue' "${STACK_FILE}"`
fi

rm "${STACK_FILE}"